#!/usr/bin/env python3
"""
SuperBirdID - åŒæ¨¡å¼æ™ºèƒ½ç»„åˆç‰ˆ
åŒæ—¶è¿è¡Œå¹³è¡¡æ¨¡å¼å’Œå¿«é€Ÿæ¨¡å¼ï¼Œæ™ºèƒ½é€‰æ‹©æœ€ä½³ç»“æœ
"""
import torch
import numpy as np
from PIL import Image
import cv2
import time

# å¯¼å…¥åŸå§‹æ¨¡å—çš„æ‰€æœ‰åŠŸèƒ½
try:
    from SuperBirdId import *
except ImportError as e:
    print(f"âŒ å¯¼å…¥æ¨¡å—å¤±è´¥: {e}")
    exit(1)

def smart_resize_balanced(image, target_size=224):
    """å¹³è¡¡æ¨¡å¼ï¼šä¼ ç»Ÿ256â†’224é¢„å¤„ç†ï¼ˆæµ‹è¯•è¯æ˜æœ€ç¨³å®šï¼‰"""
    width, height = image.size
    max_dimension = max(width, height)

    if max_dimension < 1000:
        final_image = image.resize((target_size, target_size), Image.LANCZOS)
        method_name = "ç›´æ¥è°ƒæ•´(å°å›¾åƒ)"
    else:
        # ä¼ ç»Ÿ256â†’224æ–¹æ³•
        resized_256 = image.resize((256, 256), Image.LANCZOS)
        left = (256 - target_size) // 2
        top = (256 - target_size) // 2
        final_image = resized_256.crop((left, top, left + target_size, top + target_size))
        method_name = "ä¼ ç»Ÿ256â†’224(å¹³è¡¡æ¨¡å¼)"

    return final_image, method_name

def smart_resize_fast(image, target_size=224):
    """å¿«é€Ÿæ¨¡å¼ï¼šç›´æ¥224x224"""
    final_image = image.resize((target_size, target_size), Image.LANCZOS)
    return final_image, "ç›´æ¥224x224(å¿«é€Ÿæ¨¡å¼)"

def run_single_mode_internal(image, preprocessing_func, model, bird_data, ebird_species_set,
                           use_gps_precise, db_manager, confidence_threshold=1.0):
    """è¿è¡Œå•ä¸ªæ¨¡å¼çš„è¯†åˆ«ï¼ˆå†…éƒ¨å‡½æ•°ï¼‰"""

    # é¢„å¤„ç†
    final_image, method_desc = preprocessing_func(image, target_size=224)

    # è½¬æ¢ä¸ºå¼ é‡
    img_array = np.array(final_image)
    bgr_array = cv2.cvtColor(img_array, cv2.COLOR_RGB2BGR)

    # ImageNetæ ‡å‡†åŒ–
    mean = np.array([0.406, 0.456, 0.485])
    std = np.array([0.225, 0.224, 0.229])

    normalized_array = (bgr_array / 255.0 - mean) / std
    input_tensor = torch.from_numpy(normalized_array).permute(2, 0, 1).unsqueeze(0).float()

    # æ¨ç†
    start_time = time.time()
    with torch.no_grad():
        output = model(input_tensor)
    inference_time = time.time() - start_time

    probabilities = torch.nn.functional.softmax(output[0], dim=0)
    max_confidence = probabilities.max().item() * 100

    # æå–ç»“æœ
    k = min(len(probabilities), len(bird_data), 1000)
    all_probs, all_catid = torch.topk(probabilities, k)

    candidates = []

    for i in range(all_probs.size(0)):
        class_id = all_catid[i].item()
        raw_confidence = all_probs[i].item() * 100

        if raw_confidence < confidence_threshold:
            continue

        try:
            if class_id < len(bird_data) and len(bird_data[class_id]) >= 2:
                bird_name_cn = bird_data[class_id][0]
                bird_name_en = bird_data[class_id][1]
                name = f"{bird_name_cn} ({bird_name_en})"

                # eBirdè¿‡æ»¤å’Œç½®ä¿¡åº¦è°ƒæ•´
                ebird_boost = 1.0
                ebird_match = False
                ebird_info = ""

                if ebird_species_set and db_manager:
                    ebird_code = db_manager.get_ebird_code_by_english_name(bird_name_en)
                    if ebird_code and ebird_code in ebird_species_set:
                        if use_gps_precise:
                            ebird_boost = 1.5  # GPSç²¾ç¡®50%æå‡
                            ebird_info = " [GPSç²¾ç¡®âœ“]"
                        else:
                            ebird_boost = 1.2  # å›½å®¶çº§20%æå‡
                            ebird_info = " [eBirdâœ“]"
                        ebird_match = True

                adjusted_confidence = min(raw_confidence * ebird_boost, 99.0)

                # è·å–é¸Ÿç±»åŒºåŸŸä¿¡æ¯
                bird_region = get_bird_region(bird_name_en)
                region_info = f" [åŒºåŸŸ: {bird_region}]" if bird_region != 'Unknown' else ""

                candidates.append({
                    'class_id': class_id,
                    'raw_confidence': raw_confidence,
                    'adjusted_confidence': adjusted_confidence,
                    'name': name,
                    'english_name': bird_name_en,
                    'chinese_name': bird_name_cn,
                    'ebird_match': ebird_match,
                    'ebird_boost': ebird_boost,
                    'display_info': region_info + ebird_info
                })
        except (IndexError, TypeError):
            continue

    # æŒ‰è°ƒæ•´åç½®ä¿¡åº¦æ’åº
    candidates.sort(key=lambda x: x['adjusted_confidence'], reverse=True)

    return {
        'method_desc': method_desc,
        'inference_time': inference_time,
        'max_confidence': max_confidence,
        'candidates': candidates[:10],  # ä¿ç•™å‰10ä¸ªå€™é€‰
        'total_candidates': len(candidates)
    }

def intelligent_dual_mode_recognition(image, ebird_species_set=None, use_gps_precise=False, db_manager=None):
    """æ™ºèƒ½åŒæ¨¡å¼è¯†åˆ«ï¼šå¹³è¡¡æ¨¡å¼ + å¿«é€Ÿæ¨¡å¼ç»„åˆ"""

    print("ğŸ”„ æ­£åœ¨è¿è¡ŒåŒæ¨¡å¼æ™ºèƒ½è¯†åˆ«...")

    # åŠ è½½æ¨¡å‹å’Œæ•°æ®
    model = lazy_load_classifier()
    bird_data = lazy_load_bird_info()

    # è¿è¡Œä¸¤ä¸ªæ¨¡å¼
    balanced_result = run_single_mode_internal(
        image, smart_resize_balanced, model, bird_data,
        ebird_species_set, use_gps_precise, db_manager
    )

    fast_result = run_single_mode_internal(
        image, smart_resize_fast, model, bird_data,
        ebird_species_set, use_gps_precise, db_manager
    )

    print(f"  ğŸ“Š å¹³è¡¡æ¨¡å¼: {balanced_result['method_desc']}, "
          f"æ¨ç†æ—¶é—´: {balanced_result['inference_time']:.3f}s, "
          f"æœ€é«˜ç½®ä¿¡åº¦: {balanced_result['max_confidence']:.2f}%")

    print(f"  ğŸš€ å¿«é€Ÿæ¨¡å¼: {fast_result['method_desc']}, "
          f"æ¨ç†æ—¶é—´: {fast_result['inference_time']:.3f}s, "
          f"æœ€é«˜ç½®ä¿¡åº¦: {fast_result['max_confidence']:.2f}%")

    # æ™ºèƒ½é€‰æ‹©ç­–ç•¥
    def calculate_mode_score(result):
        """è®¡ç®—æ¨¡å¼å¾—åˆ†ï¼Œé‡ç‚¹è€ƒè™‘eBird GPSåŒ¹é…çš„å‡†ç¡®æ€§"""
        base_score = result['max_confidence']

        # æ£€æŸ¥å‰3ä¸ªå€™é€‰ä¸­æ˜¯å¦æœ‰eBirdåŒ¹é…
        ebird_candidates = []
        for candidate in result['candidates'][:3]:
            if candidate['ebird_match']:
                ebird_candidates.append(candidate)

        # eBirdåŒ¹é…çš„é‡å¤§å¥–åŠ±
        if ebird_candidates:
            best_ebird_candidate = max(ebird_candidates, key=lambda x: x['adjusted_confidence'])

            # å¦‚æœæœ€ä½³eBirdå€™é€‰æ˜¯GPSç²¾ç¡®åŒ¹é…ï¼Œç»™äºˆå·¨å¤§å¥–åŠ±
            if best_ebird_candidate['ebird_boost'] == 1.5:  # GPSç²¾ç¡®
                gps_bonus = 25  # GPSç²¾ç¡®åŒ¹é…+25åˆ†
                base_score += gps_bonus

                # å¦‚æœeBirdå€™é€‰åœ¨å‰2åï¼Œé¢å¤–å¥–åŠ±
                if best_ebird_candidate in result['candidates'][:2]:
                    base_score += 15  # å‰2åeBirdå€™é€‰é¢å¤–+15åˆ†

            elif best_ebird_candidate['ebird_boost'] == 1.2:  # å›½å®¶çº§
                country_bonus = 15  # å›½å®¶åŒ¹é…+15åˆ†
                base_score += country_bonus

        # ç»“æœæ•°é‡å¹³è¡¡
        candidate_count = result['total_candidates']
        if 2 <= candidate_count <= 8:
            base_score += 2
        elif candidate_count > 15:
            base_score -= 1

        return base_score

    balanced_score = calculate_mode_score(balanced_result)
    fast_score = calculate_mode_score(fast_result)

    print(f"  âš–ï¸  æ™ºèƒ½è¯„åˆ†: å¹³è¡¡æ¨¡å¼ {balanced_score:.2f} vs å¿«é€Ÿæ¨¡å¼ {fast_score:.2f}")

    # é€‰æ‹©æœ€ä½³æ¨¡å¼
    confidence_gap = abs(balanced_result['max_confidence'] - fast_result['max_confidence'])

    if balanced_score > fast_score + 5:  # å¹³è¡¡æ¨¡å¼æ˜æ˜¾æ›´å¥½
        primary_result = balanced_result
        secondary_result = fast_result
        selected_mode = "å¹³è¡¡æ¨¡å¼"
        reason = f"ç½®ä¿¡åº¦ä¼˜åŠ¿ ({balanced_result['max_confidence']:.2f}% vs {fast_result['max_confidence']:.2f}%)"
    elif fast_score > balanced_score + 3:  # å¿«é€Ÿæ¨¡å¼æ˜æ˜¾æ›´å¥½
        primary_result = fast_result
        secondary_result = balanced_result
        selected_mode = "å¿«é€Ÿæ¨¡å¼"
        reason = f"ç»¼åˆè¯„åˆ†ä¼˜åŠ¿ ({fast_score:.2f} vs {balanced_score:.2f})"
    elif confidence_gap < 5 and fast_result['inference_time'] < balanced_result['inference_time'] * 0.8:
        # ç½®ä¿¡åº¦ç›¸è¿‘ä½†å¿«é€Ÿæ¨¡å¼æ˜æ˜¾æ›´å¿«
        primary_result = fast_result
        secondary_result = balanced_result
        selected_mode = "å¿«é€Ÿæ¨¡å¼"
        reason = f"é€Ÿåº¦ä¼˜åŠ¿ ({fast_result['inference_time']:.3f}s vs {balanced_result['inference_time']:.3f}s)"
    else:
        # é»˜è®¤é€‰æ‹©å¹³è¡¡æ¨¡å¼ï¼ˆæ›´ç¨³å®šï¼‰
        primary_result = balanced_result
        secondary_result = fast_result
        selected_mode = "å¹³è¡¡æ¨¡å¼"
        reason = "é»˜è®¤ç¨³å®šé€‰æ‹©"

    print(f"  ğŸ¯ æ™ºèƒ½é€‰æ‹©: {selected_mode} ({reason})")

    # ç»“æœèåˆï¼šä¼˜å…ˆæ˜¾ç¤ºeBird GPSéªŒè¯çš„ç‰©ç§
    all_candidates = []
    seen_species = set()

    # æ”¶é›†æ‰€æœ‰å€™é€‰ï¼Œæ ‡è®°æ¥æº
    for candidate in primary_result['candidates'][:5]:
        if candidate['english_name'] not in seen_species:
            all_candidates.append({
                'source': selected_mode,
                **candidate
            })
            seen_species.add(candidate['english_name'])

    for candidate in secondary_result['candidates'][:3]:
        if (candidate['english_name'] not in seen_species and
            candidate['adjusted_confidence'] > 3.0):  # é™ä½é˜ˆå€¼ï¼ŒåŒ…å«æ›´å¤šå€™é€‰

            other_mode = "å¿«é€Ÿæ¨¡å¼" if selected_mode == "å¹³è¡¡æ¨¡å¼" else "å¹³è¡¡æ¨¡å¼"
            all_candidates.append({
                'source': f"{other_mode}(è¡¥å……)",
                **candidate
            })
            seen_species.add(candidate['english_name'])

    # æ™ºèƒ½æ’åºï¼šeBird GPSéªŒè¯ä¼˜å…ˆï¼Œç„¶åæŒ‰ç½®ä¿¡åº¦
    def smart_sort_key(candidate):
        base_score = candidate['adjusted_confidence']

        # eBirdåŒ¹é…å·¨å¤§åŠ æƒ
        if candidate['ebird_match']:
            if candidate['ebird_boost'] == 1.5:  # GPSç²¾ç¡®
                base_score += 50  # GPSç²¾ç¡®éªŒè¯ä¼˜å…ˆçº§æœ€é«˜
            elif candidate['ebird_boost'] == 1.2:  # å›½å®¶çº§
                base_score += 25  # å›½å®¶éªŒè¯ä¹Ÿæœ‰å¾ˆé«˜ä¼˜å…ˆçº§

        return base_score

    # æŒ‰æ™ºèƒ½æ’åºé‡æ–°æ’åˆ—
    all_candidates.sort(key=smart_sort_key, reverse=True)

    # ç”Ÿæˆæœ€ç»ˆç»“æœ
    final_results = []
    for i, candidate in enumerate(all_candidates[:5]):
        final_results.append({
            'rank': i + 1,
            **candidate
        })

    return {
        'selected_mode': selected_mode,
        'selection_reason': reason,
        'balanced_result': balanced_result,
        'fast_result': fast_result,
        'final_results': final_results,
        'total_time': balanced_result['inference_time'] + fast_result['inference_time']
    }

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ¦ SuperBirdID - åŒæ¨¡å¼æ™ºèƒ½ç»„åˆç‰ˆ")
    print("=" * 60)
    print("ğŸ§  æ™ºèƒ½ç»„åˆå¹³è¡¡æ¨¡å¼å’Œå¿«é€Ÿæ¨¡å¼ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³ç»“æœ")
    print("ğŸŒ è‡ªåŠ¨å¯ç”¨eBird GPSè¿‡æ»¤ï¼Œæå‡è¯†åˆ«å‡†ç¡®æ€§")
    print("=" * 60)

    image_path = input("\nğŸ“¸ è¯·è¾“å…¥å›¾ç‰‡æ–‡ä»¶çš„å®Œæ•´è·¯å¾„: ").strip().strip("'\"")

    try:
        # åŠ è½½å›¾åƒ
        original_image = load_image(image_path)
        print(f"âœ“ å›¾åƒåŠ è½½æˆåŠŸï¼Œå°ºå¯¸: {original_image.size}")

        # GPSæ£€æµ‹
        print("\nğŸŒ æ­£åœ¨æ£€æµ‹GPSä½ç½®ä¿¡æ¯...")
        latitude, longitude, gps_info = extract_gps_from_exif(image_path)

        if latitude is not None and longitude is not None:
            auto_region, auto_country, region_info = get_region_from_gps(latitude, longitude)
            print(f"âœ“ {region_info}")
        else:
            print(f"âš  {gps_info}")
            auto_region, auto_country = None, None

        # YOLOæ£€æµ‹
        width, height = original_image.size
        max_dimension = max(width, height)

        if max_dimension > 640 and YOLO_AVAILABLE:
            print(f"\nğŸ” æ£€æµ‹åˆ°å¤§å°ºå¯¸å›¾åƒ({max_dimension}px)ï¼Œæ­£åœ¨è¿›è¡Œé¸Ÿç±»æ£€æµ‹...")
            detector = YOLOBirdDetector()
            cropped_image, detection_msg = detector.detect_and_crop_bird(image_path)

            if cropped_image is not None:
                original_image = cropped_image
                print(f"âœ“ YOLOæ£€æµ‹æˆåŠŸ")
            else:
                print(f"âš  YOLOæ£€æµ‹æœªæ‰¾åˆ°æ˜æ˜¾é¸Ÿç±»ï¼Œä½¿ç”¨åŸå§‹å›¾åƒ")

        # eBird GPSè¿‡æ»¤
        ebird_species_set = None
        use_gps_precise = False
        db_manager = lazy_load_database()

        if auto_country and EBIRD_FILTER_AVAILABLE:
            print(f"\nğŸŒ æ­£åœ¨è·å–{auto_country}åœ°åŒºçš„eBirdæ•°æ®...")
            try:
                EBIRD_API_KEY = "60nan25sogpo"
                country_filter = eBirdCountryFilter(EBIRD_API_KEY, offline_dir="offline_ebird_data")

                if latitude is not None and longitude is not None:
                    print("ä½¿ç”¨GPSç²¾ç¡®ä½ç½®æŸ¥è¯¢...")
                    ebird_species_set = country_filter.get_location_species_list(latitude, longitude, 25)
                    use_gps_precise = True
                    filter_type = "GPSç²¾ç¡®è¿‡æ»¤"
                else:
                    ebird_species_set = country_filter.get_country_species_list(auto_country)
                    filter_type = "å›½å®¶çº§è¿‡æ»¤"

                if ebird_species_set:
                    print(f"âœ“ æˆåŠŸè·å– {len(ebird_species_set)} ä¸ªç‰©ç§çš„eBirdæ•°æ® ({filter_type})")
                else:
                    print("âš  eBirdæ•°æ®è·å–å¤±è´¥")
            except Exception as e:
                print(f"âš  eBirdè¿‡æ»¤å™¨åˆå§‹åŒ–å¤±è´¥: {e}")

        # è¿è¡ŒåŒæ¨¡å¼æ™ºèƒ½è¯†åˆ«
        print(f"\n{'='*60}")
        result = intelligent_dual_mode_recognition(
            original_image, ebird_species_set, use_gps_precise, db_manager
        )

        # æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        print(f"\nğŸ¯ æœ€ç»ˆè¯†åˆ«ç»“æœ:")
        print(f"é€‰æ‹©ç­–ç•¥: {result['selected_mode']} ({result['selection_reason']})")
        print(f"æ€»å¤„ç†æ—¶é—´: {result['total_time']:.3f}ç§’")

        if ebird_species_set:
            filter_info = "GPSç²¾ç¡®è¿‡æ»¤" if use_gps_precise else f"{auto_country}å›½å®¶è¿‡æ»¤"
            print(f"eBirdè¿‡æ»¤: {filter_info} ({len(ebird_species_set)}ä¸ªç‰©ç§)")

        print(f"\nè¯†åˆ«ç»“æœ:")

        if result['final_results']:
            for res in result['final_results']:
                ebird_indicator = "ğŸŒ" if res['ebird_match'] else ""
                print(f"  {res['rank']}. {res['name']} - {res['adjusted_confidence']:.2f}% "
                      f"[{res['source']}] {ebird_indicator}{res['display_info']}")
        else:
            print("  æ— æ³•è¯†åˆ« (æ‰€æœ‰ç»“æœç½®ä¿¡åº¦è¿‡ä½)")

        # æ˜¾ç¤ºè¯¦ç»†å¯¹æ¯”ï¼ˆå¯é€‰ï¼‰
        show_details = input(f"\nğŸ“Š æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†çš„åŒæ¨¡å¼å¯¹æ¯”? (y/n): ").strip().lower()
        if show_details == 'y':
            print(f"\n{'='*40} è¯¦ç»†å¯¹æ¯” {'='*40}")

            print(f"\nğŸ“Š å¹³è¡¡æ¨¡å¼è¯¦æƒ…:")
            print(f"  é¢„å¤„ç†: {result['balanced_result']['method_desc']}")
            print(f"  æ¨ç†æ—¶é—´: {result['balanced_result']['inference_time']:.3f}ç§’")
            print(f"  æœ€é«˜ç½®ä¿¡åº¦: {result['balanced_result']['max_confidence']:.2f}%")
            print(f"  å€™é€‰ç»“æœæ•°: {result['balanced_result']['total_candidates']}")

            print(f"\nğŸš€ å¿«é€Ÿæ¨¡å¼è¯¦æƒ…:")
            print(f"  é¢„å¤„ç†: {result['fast_result']['method_desc']}")
            print(f"  æ¨ç†æ—¶é—´: {result['fast_result']['inference_time']:.3f}ç§’")
            print(f"  æœ€é«˜ç½®ä¿¡åº¦: {result['fast_result']['max_confidence']:.2f}%")
            print(f"  å€™é€‰ç»“æœæ•°: {result['fast_result']['total_candidates']}")

        print(f"\n{'='*60}")
        print("ğŸ‰ åŒæ¨¡å¼æ™ºèƒ½è¯†åˆ«å®Œæˆ!")

    except Exception as e:
        print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()